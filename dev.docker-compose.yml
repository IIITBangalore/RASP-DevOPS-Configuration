services:
  keycloakdb:
    image: postgres:latest
    container_name: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: keycloak_db
      POSTGRES_USER: keycloak_db_user
      POSTGRES_PASSWORD: keycloak_db_user_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak_db_user -d keycloak_db"]
      interval: 3s # check every 3s
      timeout: 2s # give each check 2s to respond
      retries: 5 # fail only after 5 failed checks
      start_period: 5s # initial delay before healthcheck starts

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    command: start-dev --import-realm
    ports:
      - "9080:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloakdb:5432/keycloak_db
      KC_DB_USERNAME: keycloak_db_user
      KC_DB_PASSWORD: keycloak_db_user_password
    depends_on:
      keycloakdb:
        condition: service_healthy
    volumes:
      - ./dev_keycloak_realm_data:/opt/keycloak/data/import

  mysql:
    image: mysql:latest
    container_name: mysql
    # ports:
    #   - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: visual_app_design
    restart: unless-stopped
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test:
        ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot || exit 1"]
      interval: 3s
      timeout: 2s
      retries: 5
      start_period: 5s

  mongo:
    image: mongo:latest # You can use any version you prefer
    container_name: mongo
    # ports:
    #   - "27017:27017"
    networks:
      - default
        # environment:
        #   MONGO_INITDB_ROOT_USERNAME: root
        #   MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 3s
      timeout: 2s
      retries: 5
      start_period: 5s

  rasp-designer-fe:
    image: 172.16.202.56:5000/rasp-designer-fe:dev
    container_name: rasp-designer-fe
    ports:
      - "80:80"
    depends_on:
      - keycloak
      - rasp-designer-be

  rasp-designer-be:
    image: 172.16.202.56:5000/rasp-designer-be:latest
    container_name: rasp-designer-be
    ports:
      - "9000:8000"
    environment:
      - DATABASE_URL=mysql://root:root@mysql:3306/visual_app_design
      - KEYCLOAK_URL=http://localhost:9080
      - KEYCLOAK_SERVICE_URL=http://keycloak:8080
      - REALM=myRealm
      - CLIENT_ID=adi-rest-api
      - CLIENT_SECRET=RnxVQ0TTbwETlZeN7k3lXZB78fFUt0sF
      - REDIRECT_CALLBACK_HOST=http://localhost:9000
      - FRONTEND_PORT=80
      - FRONTEND_URL=http://localhost
      - NODE_ENV=development
      - COOKIE_DOMAIN=.localhost
      - API_HOSTNAME=rasp-rbac
      - API_PORT=8082
      # ! NEVER PROVIDE THIS IN PROD AS it makes TLS connections and HTTPS requests insecure by disabling certificate verification.
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    # Login flow
    # /login (backend) -> keycloak -> auth/callback (backend) -> frontend
    depends_on:
      keycloak:
        condition: service_started
      mysql:
        condition: service_healthy
      rasp-rbac:
        condition: service_started

  rasp-rbac:
    image: 172.16.202.56:5000/rasp-rbac:latest
    container_name: rasp-rbac
    ports:
      - "9082:8082"
    networks:
      - default
    environment:
      - CLIENT_ID=adi-rest-api
      - CLIENT_SECRET=RnxVQ0TTbwETlZeN7k3lXZB78fFUt0sF
      - DEMO_RASP_BACKEND=/app
      - DMS_HOST=https://rasp-dms.localhost
      - DMS_PORT=443
      - FRONTEND_URL=https://localhost:80
      - KEYCLOAK_HOST=https://localhost:9080
      - KEYCLOAK_PORT=443
      - RASP_GENERATED_PROJECT=/app/target/
      - REALM=myRealm
      - SERVER_HOST=http://localhost
      - SERVER_PORT=8082
      - DB_SERVER=mongo
      - DB_PORT=27017
    depends_on:
      mongo:
        condition: service_healthy

volumes:
  mysql_data:
  postgres_data:
  mongo_data:
